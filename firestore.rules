rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for the 'users' collection (Keep this as is if you use it)
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Rule for the 'itemGroups' collection (Keep this as is if you use it)
    match /itemGroups/{itemGroupId} {
      allow read, write: if request.auth != null;
    }

    // Rule for the 'items' collection (Keep this as is if you use it)
    match /items/{itemId} {
      allow read, write: if request.auth != null;
    }

    // IMPORTANT: Remove or comment out your old /sales/{saleId} rule
    // if your sales are ONLY stored under the user's artifacts path.
    match /sales/{saleId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // NEW/UPDATED Rule: This rule grants read/write access to all collections
    // (like 'sales' and 'salesReturns') and documents nested under
    // 'artifacts/{appId}/users/{userId}/' for the authenticated user.
    match /artifacts/{appId}/users/{userId}/{collectionId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}